if CLIENT then
	local sprays = {}

	net.Receive("mist_updatesprays", function(length, client)
		local tbl = net.ReadTable()
		table.Merge(sprays, tbl)
	end)
		
	--hook.Add("RoundStart", "ClearSpraysCache", function()
	--	table.Empty(sprays)
	--end)
		
	hook.Add("HUDPaint","MistPaintSpraySources", function()
		for _,spray in pairs(sprays) do
			local pos = (spray.pos):ToScreen()
			
			local distance = (spray.pos-LocalPlayer():GetShootPos()):Length()
			local alpha = math.Clamp(300-distance,0,255)
			
			local ago = string.ToMinutesSeconds(CurTime() - (spray.sprayed or CurTime()))
			
			if alpha > 0 then
				draw.DrawText("Sprayed By:", "Trebuchet24", pos.x, pos.y-15, Color(255, 255, 255, alpha), TEXT_ALIGN_CENTER, TEXT_ALIGN_LEFT )
				draw.DrawText(spray.name, "Trebuchet24", pos.x, pos.y, Color(255, 255, 255, alpha), TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER )
				draw.DrawText(tostring(ago), "Trebuchet24", pos.x, pos.y + 15, Color(255, 255, 255, alpha), TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER )
			end
			--draw.DrawText("("..k..")", "TabLarge", pos.x, pos.y+15, Color(255, 255, 255, alpha), TEXT_ALIGN_CENTER, TEXT_ALIGN_RIGHT )
		end
	end)
end
if SERVER then
	local sprays = {}
	
	util.AddNetworkString("mist_updatesprays")
	
	hook.Add("PlayerSpray", "MistSprayTracker", function(ply)
	
		local uid = ply:UniqueID()
		local spray
		if sprays[uid] then
			spray = sprays[uid]
		else
			spray = {}
			sprays[uid] = spray
		end
		
		spray.sprayed = CurTime()
		
		local trace = ply:GetEyeTrace()
		
		spray.pos = trace.HitPos
		spray.ang = trace.HitNormal
		spray.name = ply:Nick()
		
		net.Start("mist_updatesprays")
		net.WriteTable({[uid]=spray})
		net.Broadcast()
		
		return false
	
	end)
	
	--hook.Add("RoundStart", "ClearSpraysCache", function()
	--	table.Empty(sprays)
	--end)
end